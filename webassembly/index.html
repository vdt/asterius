<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>WebAssembly as a Haskell compilation target - Asterius</title>
  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "WebAssembly as a Haskell compilation target";
    var mkdocs_page_input_path = "webassembly.md";
    var mkdocs_page_url = "/asterius/webassembly/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Asterius</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Home</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../building/">Building guide</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../ahc-link/">Using ahc-link</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../jsffi/">JavaScript FFI</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../vault/">The Vault</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../rts-api/">Invoking RTS API in JavaScript</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../ir/">IR types and transformation passes</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../debugging/">The runtime debugging feature</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../architecture/">Project architecture</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../wasm-in-hs/">Writing WebAssembly code in Haskell</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">WebAssembly as a Haskell compilation target</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#webassembly-as-a-haskell-compilation-target">WebAssembly as a Haskell compilation target</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#implementing-haskell-stackheap">Implementing Haskell Stack/Heap</a></li>
        
            <li><a class="toctree-l3" href="#implementing-stg-machine-registers">Implementing STG machine registers</a></li>
        
            <li><a class="toctree-l3" href="#handling-control-flow">Handling control flow</a></li>
        
            <li><a class="toctree-l3" href="#handling-relocations">Handling relocations</a></li>
        
            <li><a class="toctree-l3" href="#the-word-size-story">The word size story</a></li>
        
            <li><a class="toctree-l3" href="#pages-and-addresses">Pages and addresses</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../custom-ghc/">About the custom GHC fork</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../readings/">Reading list</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../reports/">Status reports</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Asterius</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>WebAssembly as a Haskell compilation target</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/tweag/asterius/edit/master/docs/webassembly.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="webassembly-as-a-haskell-compilation-target">WebAssembly as a Haskell compilation target</h2>
<p>There are a few issues to address when compiling Cmm to WebAssembly.</p>
<h3 id="implementing-haskell-stackheap">Implementing Haskell Stack/Heap</h3>
<p>The Haskell runtime maintains a TSO(Thread State Object) for each Haskell thread, and each TSO contains a separate stack for the STG machine. The WebAssembly platform has its own "stack" concept though; the execution of WebAssembly is based on a stack machine model, where instructions consume operands on the stack and push new values onto it.</p>
<p>We use the linear memory to simulate Haskell stack/heap. Popping/pushing the Haskell stack only involves loading/storing on the linear memory. Heap allocation only involves bumping the heap pointer. Running out of space will trigger a WebAssembly trap, instead of doing GC.</p>
<p>All discussions in the documentation use the term "stack" for the Haskell stack, unless explicitly stated otherwise.</p>
<h3 id="implementing-stg-machine-registers">Implementing STG machine registers</h3>
<p>The Haskell runtime makes use of "virtual registers" like Sp, Hp or R1 to implement the STG machine. The NCG(Native Code Generator) tries to map some of the virtual registers to real registers when generating assembly code. However, WebAssembly doesn't have language constructs that map to real registers, so we simply implement Cmm local registers as WebAssembly locals, and global registers as fields of <code>StgRegTable</code>.</p>
<h3 id="handling-control-flow">Handling control flow</h3>
<p>WebAssembly currently enforces structured control flow, which prohibits arbitrary branching. Also, explicit tail calls are missing.</p>
<p>The Cmm control flow mainly involves two forms of branching: in-function or cross-function. Each function consists of a map from <code>hoopl</code> labels to basic blocks and an entry label. Branching happens at the end of each basic block.</p>
<p>In-function branching is relatively easier to handle. <code>binaryen</code> provides a "relooper" which can recover WebAssembly instructions with structured control flow from a control-flow graph. Note that we're using our own relooper though, see issue <a href="https://github.com/tweag/asterius/issues/22">#22</a> for relevant discussion.</p>
<p>Cross-function branching (<code>CmmCall</code>) is tricky. WebAssembly lacks explicit tail calls, and the relooper can't be easily used in this case since there's a computed goto, and potential targets include all Cmm blocks involved in linking. There are multiple possible ways to handle this situation:</p>
<ul>
<li>Collect all Cmm blocks into one function, additionally add a "dispatcher" block. All <code>CmmCall</code>s save the callee to a register and branch to the "dispatcher" block, and the "dispatcher" uses <code>br_table</code> or a binary decision tree to branch to the entry block of callee.</li>
<li>One WebAssembly function for one <code>CmmProc</code>, and upon <code>CmmCall</code> the function returns the function id of callee. A mini-interpreter function at the top level repeatedly invoke the functions using <code>call_indirect</code>. This approach is actually used by the unregisterised mode of <code>ghc</code>.</li>
</ul>
<p>We're using the latter approach: every <code>CmmProc</code> marshals to one WebAssembly function. This choice is tightly coupled with some other functionalities (e.g. debug mode) and it'll take quite some effort to switch away.</p>
<h3 id="handling-relocations">Handling relocations</h3>
<p>When producing a WebAssembly binary, we need to map <code>CLabel</code>s to the precise linear memory locations for <code>CmmStatics</code> or the precise table ids for <code>CmmProc</code>s. They are unknown when compiling individual modules, so <code>binaryen</code> is invoked only when linking, and during compiling we only convert <code>CLabel</code>s to some serializable representation.</p>
<p>Currently WebAssembly community has a <a href="https://github.com/WebAssembly/tool-conventions/blob/master/Linking.md">proposal</a> for linkable object format, and it's prototyped by <code>lld</code>. We'll probably turn to that format and use <code>lld</code> some day, but right now we'll simply stick to our own format for simplicity.</p>
<h3 id="the-word-size-story">The word size story</h3>
<p>Although <code>wasm64</code> is scheduled, currently only <code>wasm32</code> is implemented. However, we are running 64-bit <code>ghc</code>, and there are several places which need extra care:</p>
<ul>
<li>The load/store instructions operate on 64-bit addresses, yet <code>wasm32</code> use <code>uint32</code> when indexing into the linear memory.</li>
<li>The <code>CmmSwitch</code> labels are 64-bit. <code>CmmCondBranch</code> also checks a 64-bit condition. <code>br_if</code>/<code>br_table</code> operates on <code>uint32</code>.</li>
<li>Only <code>i32</code>/<code>i64</code> is supported by <code>wasm32</code> value types, but in Cmm we also need arithmetic on 8-bit/16-bit integers.</li>
</ul>
<p>We insert instructions for converting between 32/64-bits in the codegen. The <code>binaryen</code> validator also helps checking bit lengths.</p>
<p>As for booleans: there's no native boolean type in either WebAssembly or Cmm. As a convention we use <code>uint32</code>.</p>
<h3 id="pages-and-addresses">Pages and addresses</h3>
<p>The WebAssembly linear memory has a hard-coded page size of 64KB. There are several places which operate in units of pages rather than raw bytes:</p>
<ul>
<li><code>CurrentMemory</code>/<code>GrowMemory</code></li>
<li><code>Memory</code> component of a <code>Module</code></li>
</ul>
<p>When performing final linking, we layout static data segments to the linear memory. We ensure the memory size is always divisable by <code>MBLOCK_SIZE</code>, so it's easy to allocate new mega blocks and calculate required page count.</p>
<p>The first 8 bytes of linear memory (from 0x0 to 0x7) are uninitialized. 0x0 is treated as null pointer, and loading/storing on null pointer or other uninitialized regions is prohibited. In debug mode the program immediately aborts.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../custom-ghc/" class="btn btn-neutral float-right" title="About the custom GHC fork">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../wasm-in-hs/" class="btn btn-neutral" title="Writing WebAssembly code in Haskell"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/tweag/asterius/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../wasm-in-hs/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../custom-ghc/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
